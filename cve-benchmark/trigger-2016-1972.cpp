#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>
#include <unistd.h>
#include <time.h>

// #define TEST_TIME

struct CRITICAL_SECTION{
    pthread_mutex_t mutex;

    CRITICAL_SECTION()
    {
        pthread_mutex_init(&mutex, NULL);
    }
};

struct Thread_id {
    int t_id;
};

void Inc(long *num)
{
    ++(*num);
}

long Dec(long *num)
{
    return --(*num);
}

void Enter(pthread_mutex_t* l)
{
    pthread_mutex_lock(l);
}

void Exit(pthread_mutex_t* l)
{
    pthread_mutex_unlock(l);
}

void* once(void* arg)
{
    //static pthread_mutex_t* lock = (pthread_mutex_t*)malloc(sizeof(pthread_mutex_t));
    static CRITICAL_SECTION* lock = new CRITICAL_SECTION();
    static long waiters = 0;
    static int done = 0;
    
    int thread_id = ((Thread_id*) arg)->t_id;
   
    if (thread_id == 1) sleep(1);
    
    if(done)
            return NULL;
   
    if (thread_id == 0) sleep(3);
    // thread1 must go to here

    Inc(&waiters);
    Enter(&(lock->mutex)); // lock, U point
    printf("T-%lx, Enter\n", pthread_self());

    if(!done)
    {
        done = 1;
    }

    printf("T-%lx, Exit\n", pthread_self());

    Exit(&(lock->mutex)); // unlock

    if(!Dec(&waiters))
    {
        printf("T-%lx, After  Decrement waiters = %ld\n",pthread_self(), waiters);
        printf("T-%lx, free lock %p\n", pthread_self(), lock);
        free(lock); // free Point
        
        lock = NULL;
    }

}

#define thread_size 2

int main()
{
#ifdef TEST_TIME
    static double run_time_begin;
    static double run_time_end;
    static double run_time_total;
    run_time_begin = clock();
#endif
    pthread_t t[thread_size];

    Thread_id thread1 = {0};
    Thread_id thread2 = {1};
    
    for(int i = 0; i < thread_size;) // only 2 threads are created here
    {
        pthread_create(&t[i], NULL, once, &thread1); // pass the thread id in args
        pthread_create(&t[i+1], NULL, once, &thread2);
        i += 2;
    }

    struct timeval start, end;
    gettimeofday( &start, NULL );

    for(int i = 0; i < thread_size;)
    {
        pthread_join(t[i], NULL);
        pthread_join(t[i+1], NULL);
        i += 2;
    }

    gettimeofday( &end, NULL );
    int timeuse = 1000000 * ( end.tv_sec - start.tv_sec ) + end.tv_usec -start.tv_usec;
    printf("time: %d us\n", timeuse);

    printf("\nprogram-successful-exit\n");
#ifdef TEST_TIME
    run_time_end = clock();
    run_time_total = run_time_end - run_time_begin;
    printf("test-the-total-time: %.3lf\n", (double)(run_time_total/CLOCKS_PER_SEC)*1000);
#endif
    return 0;
}
